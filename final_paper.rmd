---
title: |
  Budding Industry:
  Predicting the Next Dispensary Location in Toronto
author: Nicholas Bosco, Oliver Daniel, Tiago Martins, Yahui Zhang
subtitle: |
    | Final paper
    | for INF 412 (J. Wang)
    | April 7, 2023
abstract: |
  Using a number of statistical methods, we train regression models with data regarding the locations of cannabis dispensaries and private businesses in the city of Toronto. These models, in turn, are designed to predict where in the city the next cannabis retail location is most likely to open. After narrowing our scope of investigation to ten types of businesses and the 102 Forward Sortation Areas of Toronto, as used by postal services, our model reports a number of statistically-significant correlations between the presence of given businesses in a region and the establishment of dispensaries. A secondary model is also proposed, simplifying its predictors using the Akaike Information Criterion and K-fold Cross Validation to achieve accuracy in excess of 80%. Limitations to this study are also discussed, including a comparative dearth of dispensary information – in particular those many retail locations in Toronto that are not directly licensed by the province of Ontario – and a lack of other constraints outside of nearby businesses to predict dispensary counts in fairly large geographic areas.
bibliography: 'paper/.bib'
link-citations: true
nocite: "@*"
output:
  bookdown::pdf_document2:
    number_sections: false
    fig_caption: true
    toc: false
    toc_depth: 2
  bookdown::html_document2:
    number_sections: false
    fig_caption: true
  
header-includes:
  - \usepackage{longtable}
  - \usepackage{booktabs}
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \floatplacement{table}{H}
---

\tableofcontents
\newpage
```{r setup, echo=FALSE}
# knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = FALSE,
  fig.width = 12,
  fig.height = 7,
  fig.align = "center"
)
```

```{r libraries}
library(tidyverse)
library(janitor)
library(modelsummary)
library(caret)
library(sf)
```

```{r load data, include=FALSE}
source("scripts/fetch-and-clean-data.r")
```

```{r utils}
fmt <- function(n, is_double = FALSE) {
  nsmall <- `if`(
    is_double, 2, 0
  )
  format(round(n, digits = nsmall), nsmall = nsmall, big.mark = ",")
}
```

# Introduction

With currently 417 marijuana dispensaries in the city of Toronto, and more likely to be opened in the near future, it begs the question as to where the next dispensary might open. The Alcohol and Gaming Commission of Ontario's iAGCO map displays currently opened dispensaries, and while this information is important to consider, it offers little in the way of ascertaining where a new dispensary might open next. Our group is curious as to what factors influence the location of a new dispensary, particularly the presence of different types of businesses in the area. By performing a logistic regression, our group hopes to predict the likeliest location for a new dispensary based on different types of nearby businesses.

## Background
First among the two sources we consulted for this assignment was Planning for Marijuana: The Cannabis Conundrum, by Jeremy Németh & Eric Ross. The stated purpose of this article was to explore the local regulation of medical marijuana dispensaries in various states in the US, and by what factors are different zones determined as eligible for new dispensaries, and which factors inhibit the construction of a medical marijuana dispensary (MMD). Of information that was particularly relevant to use, this report found that so-called “buffers” severely diminished an MMD's chances of being built in a given neighborhood. These buffers included the existence of other MMDs, but also “sensitive facilities” such as childcare centres, churches, libraries, parks, and also cinemas, recreation centres, and tobacco stores. Furthermore, these buffer businesses included bars, fast food restaurants, and liquor stores on the basis of resident's concerns of crime and further diminishing property values.

Our second source is Locating Medical and Recreational Cannabis Outlets for Research
Purposes: Online Methods and Observational Study, an effort to determine the means of locating and observing both licensed and unlicensed dispensaries in Los Angeles County. While the main objective of this study was to determine which of the located dispensaries were open for business, the study also contained additional details regarding the dispensaries in question. Of interest to us was the finding of how 40.6% of identified dispensaries had a tobacco store in close proximity.


## Data
### Dispensaries
In the province of Ontario, all cannabis retail locations must be issued a license by the Alcohol and Gaming Commission of Ontario [@AGCO] before opening. If the application is not rejected outright, the location owners must place a 'Public Notice' placard in their proposed store for a 15-day period before the ACGO will consider approving the application and allowing cannabis sales to begin. The ACGO maintains an online directory of all current applications, regardless of status, across the province, as well as a corresponding interactive map.

This map, ulimately, is fed by a CSV file on the ACGO webserver [@arcgis_web_application]. The URL to this CSV is accessible to the public without credentials, and is available for download; see line 11 in `scripts/fetch-and-clean-data.r`. Within is a wealth of data for Ontario dispensary applications, including names, addresses, application status, geographic coordinates, and more. For the purposes of this paper, we excluded any application which did not satisfy the following:

1. The application status must be **Authorized to Open**, i.e., neither rejected nor currently in public notice at the time of download; and
2. The dispensary's postal code must begin with **M**, which indicates that the address is serviced by a Toronto FSA^[This is a useful heuristic for discriminating what addresses are "within" the City of Toronto.].

Filtering by these two criteria, we were left with a total of `r nrow(clean_dispensaries)` open dispensaries within the City of Toronto, from each of which we retained only the FSA and, for plotting purposes, latitude and longitude. Other identifying details, such as specific addresses and store names, were discarded.

### Businesses
Through the Open Data Toronto initiative, the City of Toronto offers to the public a listing of all current business licenses^[i.e., those private business licenses that can be issued at the City's discretion, excluding e.g., liquor and cannabis retail locations.] issued within the Greater Toronto Area. Along with business information and addresses, the data also featured the `category` of business under which the issued license falls. These are also available for download in multiple useful formats, such as CSV. [@Opendatatoronto]

The data were filtered again by the first letter of their postal code to limit addresses to those within the City of Toronto. However, this still resulted in `r n_distinct(clean_businesses$category)` different business categories. For the purpose of this paper, we limited our data to only `r length(desired_businesses)`:

```{r business-types}
tibble(name = desired_businesses) |> knitr::kable(longtable = TRUE)
```

For a total of `r fmt(nrow(clean_businesses))` suitable businesses. For each of these businesses, only the FSA and category were retained.

#### Business types
These ten business types were chosen through a combination of our background research, such as including vapour products in relation to @pedersen_firth_parker_shih_davenport_rodriguez_dunbar_kraus_tucker_damico_et_al._2020; total quantities throughout Toronto to prevent data scarcity issues with prediction; and intuition. Apart from reducing the dimensionality of our predictors to a more manageable and presentable volume, analyzing this smaller number of types of businesses will also allow us to more closely follow the methods present in e.g., @nemeth_ross_2014.

### Forward Sortation Areas (FSAs)
Using data drawn from the Census, the Canadian federal government subdivides the geography of Canada into 1,620 unique **Forward Sortation Areas**, or FSAs [@FSAdef]. Each address found within an FSA shares the same first three characters of their postal code, which makes these three characters a convenient shorthand for a particular region of Canada for purposes of shipping, travel, and more. Conveniently, the City of Toronto is so large that it gets its own prefix for FSAs: M. This is why the dispensary and business license data were filtered to those whose postal codes began with M above.

For the purposes of this paper, a series of shapefiles [@UofTFSA] outlining the FSAs was downloaded from the UofT digital library. Although the file was uploaded in 2005 and Toronto's FSAs have changed slightly in 2023, we considered this a minor issue for the purposes of our experiment. Note that, although the source code^[https://github.com/oliver-daniel/inf_412_final_project] for this paper is available online, this shapefile is proprietary and can only be accessed by UofT faculty and staff with valid credentials.

# Methodology

In this project, we aim to predict whether there is a sufficient number of cannabis dispensaries in each Forward Sortation Area (FSA) in the city of Toronto. To do this, we used data on cannabis retail locations from the Alcohol and Gaming Commission of Ontario (AGCO) and business license data from the Open Data Toronto initiative. We filtered the data based on specific criteria and used logistic regression to build a predictive model.
 
## Assumptions
1. The postal codes, and by extension FSAs, provided in the dataset are accurate and up-to-date with the dispensaries and businesses in Toronto.
2. The more frequent certain business types are, the greater the chance a dispensary will be there too.
3. Dispensaries propagate beside each other, as in @hotelling_1929.

## Data Filtering and Preparation

As mentioned in the introduction section, we have filtered our dispensary data by their application status, where we only included dispensaries with an "Authorized to Open" status. Since our analysis will only focus on the city of Toronto, we will be only considering dispensaries and businesses within the City of Toronto by focusing on postal codes starting with "M"
 
Due to a large number of business categories, we further narrowed down our focus to 10 specific categories (types of business) that would have the most impact on the location of dispensaries based on our background research. Meanwhile, we retained the FSA, latitude, and longitude of each dispensary for further analysis.

## Data Visualization
 
Scatterplots were created to visualize the relationship between our binary dependent variable (1 if the FSA has more than or equal to 3 dispensaries, 0 if less than 3 dispensaries) and the independent variables (the 10 selected business categories). Additionally, we used the SF package in R [@citeSF] to create spatial visualizations, showing the locations of dispensaries and the density of each business type within each FSA based on the assumption that dispensaries propagate beside each other.

## Logistic Regression Model

To predict whether an FSA has a sufficient number of dispensaries, we built a logistic regression model, considering the assumption that the more frequent a business type is, the greater the chance a dispensary will be there too. The binary dependent variable was created based on the dispensary count in each FSA, with a class of 1 if there were more than or equal to 3 dispensaries and 0 if there were fewer than 3 dispensaries. The independent variables were the counts of the selected business categories within each FSA. Upon building our initial model, we performed model selection using the Akaike Information Criterion (AIC) in both directions, which reduced the number of independent variables from 10 to 6. In this context, choosing the model with the lowest AIC helped us reduce the number of independent variables from our initial model as it provides a better balance between goodness-of-fit and model complexity. The AIC helped identify the best model among a set of candidate models by penalizing models with too many parameters, preventing overfitting.

The benefits of testing AIC on our model can be summarized as follows:

1. **Penalize model complexity**: AIC includes a penalty term for the number of parameters in the model, which discourages overfitting. This penalty term increases with the number of parameters, making models with a higher number of independent variables less favourable unless they provide a significant improvement in goodness-of-fit.
2. **Balance goodness-of-fit and simplicity**: AIC aims to find a model that best explains the data while remaining as simple as possible. It takes into account both the goodness-of-fit (measured by the likelihood) and the complexity of the model (measured by the number of parameters). Lower AIC values indicate a better balance between the two.
3. **Model comparison**: AIC provides a metric for comparing different models and helps in selecting the best model among a set of candidate models. When using AIC for model selection, the model with the lowest AIC value is considered the best.
4. **Considers sample size**: AIC takes into account the sample size, making it suitable for different sample sizes. It tends to favour more complex models when the sample size is large and simpler models when the sample size is small.
 
By selecting the model with the lowest AIC value, we aimed to find the best balance between model complexity and goodness-of-fit, ultimately leading to a model that generalizes well to new data and avoids overfitting.

## Model Validation
 
To validate our logistic regression model, we employed k-fold cross-validation. The model achieved an accuracy rate of 0.85 and a kappa of 0.71, indicating a good level of performance in predicting whether an FSA has a sufficient number of dispensaries based on the selected business categories and our assumptions.
 
In summary, our analysis involved filtering data on dispensaries and businesses, creating visualizations to explore relationships between variables based on our assumptions, and building and validating a logistic regression model to predict whether an FSA has a sufficient number of dispensaries. The model demonstrated good performance in predicting the sufficiency of dispensaries in each FSA based on the selected business categories and the assumptions we made.

# Results

## Scatter plots

For the plots shown below in Figure \@ref(fig:scatterplots), note the free scales for both axes.

```{r}
merged_counts <- left_join(
  dispensary_counts,
  business_counts,
  by = "fsa",
  suffix = c(".dispensaries", ".businesses")
)
```

```{r scatterplots, fig.cap="The red horizontal line represents the delineation between class-0 and class-1 FSAs: the dots found above the line represent those FSAs which have at least 3 dispensaries, and vice versa.", fig.height=11.5}
merged_counts |>
  group_by(category) |>
  ggplot(aes(x = n.businesses, y = n.dispensaries)) +
  geom_point(alpha = 0.5, size = 0.7, color = "cornflowerblue") +
  geom_line(aes(y = 3), color = "red") +
  facet_wrap(~category, scales = "free", ncol = 3) +
  labs(
    title =
      "Comparison of FSAs by counts of various business types and dispensaries",
    x = "Number of business licenses",
    y = "Number of dispensaries"
  )
```

## Spatial Visualization

```{r spatial-setup}
fsas_by_category <- clean_fsas |>
  left_join(business_counts, by = "fsa") |>
  drop_na(category)
```

```{r chloropleths, results="hide", fig.keep="all", fig.cap="The green dots in each chloropleth map represent the location of dispensaries."}
fsas_by_category |>
  group_by(category) |>
  do(plots = ggplot(.) +
    geom_sf(data = clean_fsas, fill = "black") +
    geom_sf(aes(fill = n)) +
    geom_point(
      data = clean_dispensaries,
      mapping = aes(x = longitude, y = latitude),
      color = "green",
      size = .25,
      alpha = .5,
    ) +
    scale_fill_viridis_c(option = "magma") +
    labs(
      title = paste(
        "Count map of",
        .$category[1] |> str_replace_all("_", " ") |> str_to_sentence(),
        "per FSA of Toronto",
        collapse = ""
      ),
      y = NULL,
      x = NULL
    ) +
    theme_void() +
    theme(
      axis.ticks = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank()
    )) |>
  pull(plots)
```

<!-- TODO I don't know how to fix this spacing lol -->
```{r summary-table, fig.cap="Data Summary", fig.width=6, results="asis"}

# Make a pivot table with counts of all features
# inside each FSA
fsa_counts_pivot <- fsa_counts |>
  pivot_wider(
    names_from = category, values_from = n.businesses,
    values_fill = 0
  ) |>
  select(-c(geometry, `NA`))
# display the summary as a table in R Markdown
datasummary_skim(
  fsa_counts_pivot,
  type = "numeric",
  output = "default",
  fmt = "%.1f",
  histogram = TRUE,
  title = "Data Summary",
  notes = NULL,
  align = NULL,
  escape = TRUE,
)
```

## Logistical Model

### Logistical Model before AIC
```{r define-model, fig.cap="Logistic model before AIC",fig.height=7, fig.width=12, echo=FALSE}
# Fit a logistic regression model
logistic_model <- glm(
  class ~
    adult_entertainment_club + eating_establishment +
    entertainment_establishment_nightclub + pawn_shop +
    payday_loan + sidewalk_cafe + retail_store_food +
    smoke_shop + vapour_product_retailer + holistic_centre,
  data = fsa_counts_pivot, family = binomial
)

summary(logistic_model)
```

### Logistical Model after AIC
```{r Twenty-three, fig.cap="Logistic model after AIC",fig.height=7, fig.width=12, echo=FALSE}

# Improved logistic model
logistic_model2 <- glm(
  class ~
    adult_entertainment_club + entertainment_establishment_nightclub +
    pawn_shop + sidewalk_cafe + retail_store_food + smoke_shop,
  data = fsa_counts_pivot, family = binomial
)

summary(logistic_model2)
```


### Exponentiate the coefficients
```{r Twenty-four, fig.cap="Exponentiate the coefficients", results="asis"}

# Improved logistic model
tmp <- exp(coef(logistic_model2))
print(tmp)
```

### K-fold cross-validation
```{r Twenty-five, fig.cap="Exponentiate the coefficients",fig.height=7, fig.width=12, echo=FALSE}

# Set seed for reproducibility
set.seed(123)

# Define cross-validation settings
ctrl <- trainControl(method = "cv", number = 10)

# Train the model using k-fold cross-validation
fit <- train(
  factor(class) ~
    adult_entertainment_club + entertainment_establishment_nightclub +
    pawn_shop + sidewalk_cafe + retail_store_food + smoke_shop,
  data = fsa_counts_pivot, method = "glm", family = binomial, trControl = ctrl
)

# Get results
print(fit)
```
\newpage

# Discussion

## Data Summary

The summary statistics, as shown in Figure \@ref(tab:summary-table), express the distribution of the individual predictors across FSAs with the histogram bars on the side. The `unique` value explains the different kinds of categories within the predictors. What is interesting to note here is that some of the unique values repeat among the different groups. This may be indicative of double counting (i.e. a eating establishment also licensed as a retail food store). The data summary does a sufficient job in expressing the central tendency measures of the individual predictors which comes in handy when trying to understand distributions of the dataset. This graph would not be possible without the help of Skimr and Model Summary (@skimr, @modelsummary).

## The Model

### Before AIC
Logistical Model Before AIC:
Before AIC, the model consisted of ten predictors, each being one type of business present within the FSAs The types that were chosen were believed to determine the likelihood of the dispensary being in close proximity within each FSA, as selected through the background research provided above (@nemeth_ross_2014, @pedersen_firth_parker_shih_davenport_rodriguez_dunbar_kraus_tucker_damico_et_al._2020, etc.). When examining the results from the model summary, most of the other predictors like vapor product retailer, payday loan and eating establishment had no effect on the opening of dispensaries whatsoever. It was quite surprising to see smoke shop, and vapour product retailers not be significant in the proximity to dispensaries as the practices of the three businesses are essentially the same; the only difference is what exactly is consumed (tobacco, or juice pods or cannabis). At times semantically people use the words interchangeably (smoking, vaping etc) and the team thought this semantic insight may mean different things for different people.

### After AIC

```{r}
coefs_2 <- summary(logistic_model2) |> coef()
exp_coefs_2 <- exp(coefs_2)

results_table <- coefs_2 |>
  cbind(odds_ratio = exp_coefs_2[, "Estimate"], Name = rownames(coefs_2)) |>
  as_tibble() |>
  slice(2:n()) |>
  select(Name,
    `Log Odds` = `Estimate`,
    `Unit Change to Odds Ratio` = odds_ratio,
    `p-value` = `Pr(>|z|)`
  ) |>
  mutate(across(2:4, ~ as.numeric(.) |> round(digits = 3)))
```

#### Intercept
**Estimated Log Odds**: `r fmt(coefs_2["(Intercept)", "Estimate"], TRUE)`

**Odds Ratio**: `r fmt(exp_coefs_2["(Intercept)", "Estimate"], TRUE)`

**Explanation**: If no businesses whatsoever are found within an FSA, the odds of a dispensary opening within it are roughly 1%.

#### Other values
For all other businesses, our updated model exhibits the following predicted changes to odds per unit. That is, for every -- say -- restaurant in an FSA, the likelihood of at least 3 dispensaries being open in that same FSA increase by 1%, to a high degree of statistical significance. Conversely, for every nightclub, the likelihood of the FSA being class-1 in terms of dispensary count decreases by about 15%, though this effect does not have as high a degree of significance with our data. See Table \@ref(tab:coefs-table) below:

```{r coefs-table}
knitr::kable(results_table,
  caption = "Note that, despite the AIC optimizations, not all results are statistically significant with $\\alpha = 0.05.$",
  longtable = TRUE
)
```



# Conclusion
Our regression model indicates that at least certain types of businesses are significantly ($p < 0.05$) correlated to the likelihood of dispensaries being opened in an arbitrary FSA-sized region of Toronto. Simple improvements, such as reducing the dimensionality of the prediction space using AIC as a heuristic and K-fold Cross Validation, proved effective in improving predictive power to up to 85. Where higher numbers of dispensaries have already been opened, often the most densely populated regions of the city, co-location of multiple dispensaries in close proximity may indicate the longer-term stability of retail cannabis in those areas. However, statistical modelling can prove to be an effective tool in determining which geographic regions may be hospitable to a burgeoning cannabis market, inviting early investment and temporarily enjoying the dividends of low competition.

## Considerations
### Data is sparse
Being only a few years removed from legalization, cannabis retail is still in its nascent stages, with even more veteran markets being only a few years its senior. The scene is changing daily, and it is difficult even for licensing bodies like AGCO to track the opening and closing of new locations. This is especially true of grey-market dispensaries, such as First Nations-owned locations which operate on the fringes of treaty law. Although efforts exist to collect and list them, primarily for consumer-facing purposes, there is a distinct lack of verified, up-to-date data on these locations. It would be of particular interest to investigate these locations and their market penetration through further study.

### Possible confounding factors
The scope of our study fails to control for a number of important factors, which could bear significant impact on our statistical findings. These include:

#### Population
The high variance in population density across the City of Toronto is a latent variable that affects the density of dispensaries and other businesses alike: where there are more people, there will certainly be more establishments to serve them. It is unknown to what extent our model accounts for this, and it is possible that certain signficant factors for dispensary presence in an FSA could be reliant on data only from downtown regions.

#### Regulations and public infrastructure
Our dataset includes only private business addresses, excluding non-business institutions such as schools, places of worship, and entrances to public and government infrastructure. Future research into the legal constraints of dispensary location – distance from schools, by-law regulations, etc. – may indicate other forces acting on the location of the next dispensary when estimating.

#### Geospatial granularity
The choice to use the 102 FSAs^[As of 2005.] of the City of Toronto as geographic subdivisions was a largely arbitrary one, looking to balance predictive power with visibility and performance when authoring this paper. Other options considered included the electoral ridings or neighbourhood designations of the city; an arbitrary quadrilateral or hexagonal grid, overlain atop a map of Toronto; and even a Voronoi cell system connecting adjacent street intersections into "blocks". Each of these was deemed unsuitable for varied reasons, but future reproductive studies may wish to test whether our results are repeatable on coarser- or finer-grained geographic scales.

<!-- ## Appendix -->
\newpage
# References