---
title: Final Paper
author: Nicholas Bosco, Oliver Daniel, Tiago Martins, Yahui Zhang
subtitle: |
    | for INF 412 (J. Wang)
    | March 26, 2023
bibliography: '.bib'
link-citations: true
output:
  bookdown::pdf_document2:
    number_sections: false
    fig_caption: true
    toc: true
    toc_depth: 4
  bookdown::html_document2:
    number_sections: false
    fig_caption: true
header-includes:
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \floatplacement{table}{H}
---

```{r setup, echo=FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
    echo = FALSE,
    message = FALSE,
    warning = FALSE,
    cache = FALSE
)
```

```{r libraries}
library(tidyverse)
library(janitor)
library(dplyr)
library(skimr)
library(modelsummary)
library(carData)
library(car)
library(MASS)
library(sf)
library(ggplot2)
library(summarytools)
library(knitr)
library(stargazer)
library(jtools)
library(caret)
```

```{r load data, include=FALSE}
#load clean data 
clean_businesses2 <- read.csv("data/clean_businesses_final.csv")
clean_businesses_count <- read.csv("data/clean_businesses_count.csv")
clean_dispensaries_final <- read.csv("data/clean_dispensaries_final.csv")
clean_dispensaries_count <- read.csv("data/clean_dispensaries_count.csv")
merged_data <- read.csv("data/merged_data.csv")
merged_data_wclass1 <- read.csv("data/merged_data_wclass.csv")

# IMPORTANT: see README for instructions on properly installing FSA shapefiles.
toronto_fsas <- st_read("data/ONfsa.shp")

```

```{r spatial clean, include=FALSE}
# Change column name for later merge
colnames(clean_businesses_count)[colnames(clean_businesses_count) == "FSA_postal_code"] <- "FSA"

# merge two dataset
toronto_fsas_businesses <- merge(toronto_fsas, clean_businesses_count, by = "FSA")

# Convert the clean_dispensaries_final to a spatial dataframe:
clean_dispensaries_final_sf <- st_as_sf(clean_dispensaries_final, coords = c("longitude", "latitude"), crs = 4326)

# Convert the clean_dispensaries_final_sf to the same projection as toronto_fsas_businesses:
x_data_sf_proj <- st_transform(clean_dispensaries_final_sf, st_crs(toronto_fsas_businesses))

# Spatially join the x_data_sf_proj with the toronto_fsas_businesses:
toronto_fsas_businesses_x <- st_join(toronto_fsas_businesses, x_data_sf_proj)

# Change the coloumn names for easier reference
colnames(toronto_fsas_businesses_x) <- tolower(gsub(" ", "_", colnames(toronto_fsas_businesses_x)))

names(toronto_fsas_businesses_x)[names(toronto_fsas_businesses_x) == "entertainment_establishment/nightclub"] <- "entertainment_establishment_nightclub"

names(toronto_fsas_businesses_x) <- gsub("[()]", "", names(toronto_fsas_businesses_x))

```

# Introduction

# Methodology

# Results

## Scatter plots
```{r one, fig.cap="Sidewalk cafe vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = sidewalk_cafe, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of sidewalk cafe vs Class")
```

```{r two, fig.cap="Adult entertainment club vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = adult_entertainment_club, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of adult entertainment club vs Class")
```

```{r three, fig.cap="Eating establishment vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = eating_establishment, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of eating establishment vs Class")
```

```{r four, fig.cap="Entertainment establishment (nightclub) vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = entertainment_establishment_nightclub, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of entertainment establishment (nightclub) vs Class")
```

```{r five, fig.cap="Pawn shop vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = pawn_shop, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of pawn shop vs Class")
```

```{r six, fig.cap="Payday loan vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = payday_loan, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of payday loan vs Class")
```

```{r seven, fig.cap="Retail store (food) vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = retail_store_food, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of retail store (food) vs Class")
```

```{r eight, fig.cap="Adult entertainment club vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = adult_entertainment_club, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of adult entertainment club vs Class")
```

```{r nine, fig.cap="Eating establishment vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = eating_establishment, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of eating establishment vs Class")
```

```{r ten, fig.cap="Entertainment establishment (nightclub) vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot(data = merged_data_wclass1, aes(x = entertainment_establishment_nightclub, y = class)) + 
  geom_point(alpha = 0.5, size = 0.7,color = "cornflowerblue") + 
  ggtitle("Scatter plot of entertainment establishment (nightclub) vs Class")
```

## Spatial Visualization
```{r eleven, fig.cap="Sidewalk cafe vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = sidewalk.cafe)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Sidewalk Cafe", option = "cividis") +
  theme_void()
```

```{r twelve, fig.cap="Adult Entertainment Club vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = adult.entertainment.club)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Adult entertainment club", option = "cividis") +
  theme_void()
```

```{r thirteen, fig.cap="Eating establishment vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = eating.establishment)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Eating establishment", option = "cividis") +
  theme_void()
```

```{r fourteen, fig.cap="Entertainment establishment (nightclub) vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = entertainment.establishment.nightclub)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Entertainment establishment (nightclub)", option = "cividis") +
  theme_void()
```

```{r fifteen, fig.cap="Pawn shop vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = pawn.shop)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Pawn shop", option = "cividis") +
  theme_void()
```

```{r sixteen, fig.cap="Payday loan vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = payday.loan)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Payday loan", option = "cividis") +
  theme_void()
```

```{r seventeen, fig.cap="Retail store (food) vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = retail.store..food.)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Retail store (food)", option = "cividis") +
  theme_void()
```

```{r eighteen, fig.cap="Smoke shop vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = smoke.shop)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Smoke shop", option = "cividis") +
  theme_void()
```

```{r nineteen, fig.cap="Vapour product retailer vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = vapour.product.retailer)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Vapour product retailer", option = "cividis") +
  theme_void()
```

```{r twenty, fig.cap="Holistic centre vs dispensaries",fig.height=7, fig.width=12, echo=FALSE}
ggplot() +
  geom_sf(data = toronto_fsas_businesses_x, aes(fill = holistic.centre)) +
  geom_point(
    data = clean_dispensaries_final,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .5,
    alpha = .5,
    inherit.aes = F
  ) +
  scale_size_continuous(range = c(2, 10)) + 
  scale_fill_viridis_c("Holistic centre", option = "cividis") +
  theme_void()
```

## Data Summary

```{r Twenty-one, fig.cap="Data Summary",fig.height=7, fig.width=12, echo=FALSE}


# display the summary as a table in R Markdown
datasummary_skim(
  merged_data_wclass1,
  type = "numeric",
  output = "default",
  fmt = "%.1f",
  histogram = TRUE,
  title = "Data Summary",
  notes = NULL,
  align = NULL,
  escape = TRUE,
) 

```

## Logistical Model

### Logistical Model before AIC
```{r Twenty-two, fig.cap="Logistic model before AIC",fig.height=7, fig.width=12, echo=FALSE}

# Fit a logistic regression model
logistic_model <- glm(class ~ adult_entertainment_club + eating_establishment + entertainment_establishment_nightclub + pawn_shop + payday_loan + sidewalk_cafe + retail_store_food + smoke_shop + vapour_product_retailer + holistic_centre, data = merged_data_wclass1, family = binomial) 

summary(logistic_model)

```

### Logistical Model after AIC
```{r Twenty-three, fig.cap="Logistic model after AIC",fig.height=7, fig.width=12, echo=FALSE}

# Improved logistic model
logistic_model2 <- glm(class ~ adult_entertainment_club + entertainment_establishment_nightclub + pawn_shop + sidewalk_cafe + retail_store_food + smoke_shop, data = merged_data_wclass1, family = binomial)

summary(logistic_model2)

```


### Exponentiate the coefficients
```{r Twenty-four, fig.cap="Exponentiate the coefficients",fig.height=7, fig.width=12, echo=FALSE}

# Improved logistic model
exp(coef(logistic_model2))

```

### K-fold cross-validation
```{r Twenty-five, fig.cap="Exponentiate the coefficients",fig.height=7, fig.width=12, echo=FALSE}

# Set seed for reproducibility
set.seed(123)

# Define cross-validation settings
ctrl <- trainControl(method = "cv", number = 10)

# Train the model using k-fold cross-validation
fit <- train(factor(class) ~ adult_entertainment_club + entertainment_establishment_nightclub + pawn_shop + sidewalk_cafe + retail_store_food + smoke_shop, data = merged_data_wclass1, method = "glm", family = binomial, trControl = ctrl)

# Get results
print(fit)

```
\newpage

# Discussion

# Conclusion
Our regression model indicates that at least certain types of businesses are significantly ($p < 0.05$) correlated to the likelihood of dispensaries being opened in an arbitrary FSA-sized region of Toronto. [todo more about AIC, methodologies, etc.] Where higher numbers of dispensaries have already been opened, often the most densely populated regions of the city, co-location of multiple dispensaries in close proximity may be indicative of the longer-term stability of retail cannabis in those areas. However, statistical modelling can prove to be an effective tool in determining which geographic regions may be hospitable to a burgeoning cannabis market, inviting early investment and temporarily enjoying the dividends of low competition.

## Considerations
### Data is sparse
Being only a few years removed from legalization, cannabis retail is still in its nascent stages, with even more veteran markets being only a few years its senior. The scene is changing daily, and it is difficult even for licensing bodies like AGCO to track the opening and closing of new locations. This is especially true of black- and grey-market dispensaries, such as First Nations-owned locations which operate on the fringes of treaty law. Although efforts exist to collect and list them, primarily for consumer-facing purposes, there is a distinct lack of verified, up-to-date data on these businesses. It would be of particular interest to investigate these businesses and their market penetration through further study.

### Possible confounding factors
The scope of our study fails to control for a number of important factors, which could bear significant impact on our statistical findings. These include:

#### Population
The high variance in population density across the City of Toronto is a latent variable that affects the density of dispensaries and other businesses alike: where there are more people, there will certainly be more establishments to serve them. It is unknown to what extent our model accounts for this, and it is possible that certain signficant factors for dispensary presence in an FSA could be reliant on data only from downtown regions.

#### Regulations and public infrastructure
Our dataset includes only private business addresses, excluding non-business institutions such as schools, places of worship, and entrances to public and government infrastructure. Future research into the legal constraints of dispensary location – distance from schools, by-law regulations, etc. – may indicate other forces acting on the location of the next dispensary when estimating.

#### Geospatial granularity
The choice to use the 102 FSAs^[As of 2005.] of the City of Toronto as geographic subdivisions was a largely arbitrary one, looking to balance predictive power with visibility and performance when authoring this paper. Other options considered included the electoral ridings or neighbourhood designations of the city; an arbitrary quadrilateral or hexagonal grid, overlain atop a map of Toronto; and even a Voronoi cell system connecting adjacent street intersections into "blocks". Each of these was deemed unsuitable for varied reasons, but future reproductive studies may wish to test whether our results are repeatable on coarser- or finer-grained geographic scales.