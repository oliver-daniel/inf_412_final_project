---
title: Final Paper
author: Nicholas Bosco, Oliver Daniel, Tiago Martins, Yahui Zhang
subtitle: |
    | for INF 412 (J. Wang)
    | March 26, 2023
bibliography: '.bib'
link-citations: true
output:
  bookdown::pdf_document2:
    number_sections: false
    fig_caption: true
    toc: true
    toc_depth: 4
  bookdown::html_document2:
    number_sections: false
    fig_caption: true
header-includes:
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \floatplacement{table}{H}
---

```{r setup, echo=FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = FALSE
)
```

```{r libraries}
library(tidyverse)
library(janitor)
library(modelsummary)
library(caret)
```

```{r load data, include=FALSE}
source("scripts/fetch-and-clean-data.r")
```

```{r utils}
fmt <- function(n, is_double = FALSE) {
  nsmall <- `if`(
    is_double, 2, 0
  )
  format(round(n, digits = nsmall), nsmall = nsmall, big.mark = ",")
}
```

# Introduction

## Data
### Dispensaries
In the province of Ontario, all cannabis retail locations must be issued a license by the Alcohol and Gaming Commission of Ontario (AGCO) before opening. If the application is not rejected outright, the location owners must place a 'Public Notice' placard in their proposed store for a 15-day period before the ACGO will consider approving the application and allowing cannabis sales to begin. The ACGO maintains an online directory of all current applications, regardless of status, across the province, as well as a corresponding interactive map.

This map, ulimately, is fed by a CSV file on the ACGO webserver. The URL to this CSV is accessible to the public without credentials, and is available for download; see line 11 in `scripts/fetch-and-clean-data.r`. Within is a wealth of data for Ontario dispensary applications, including names, addresses, application status, geographic coordinates, and more. For the purposes of this paper, we excluded any application which did not satisfy the following:

1. The application status must be **Authorized to Open**, i.e., neither rejected nor currently in public notice at the time of download; and
2. The dispensary's postal code must begin with **M**, which indicates that the address is serviced by a Toronto FSA^[This is a useful heuristic for discriminating what addresses are "within" the City of Toronto.].

Filtering by these two criteria, we were left with a total of `r nrow(clean_dispensaries)` open dispensaries within the City of Toronto, from each of which we retained only the latitude, longitude, and FSA. Other identifying details, such as specific addresses and store names, were discarded.

### Businesses
Through the Open Data Toronto initiative, the City of Toronto offers to the public a listing of all current business licenses^[i.e., those private business licenses that can be issued at the City's discretion, excluding e.g., liquor and cannabis retail locations.] issued within the Greater Toronto Area. Along with business information and addresses, the data also featured the `category` of business under which the issued license falls. These are also available for download in multiple useful formats, such as CSV.

The data were filtered again by the first letter of their postal code to limit addresses to those within the City of Toronto. However, this still resulted in `r clean_businesses |> pull(category) |> unique() |> length()` different business categories. For the purpose of this paper, we limited our data to only `r length(desired_businesses)`:

```{r business types}
tibble(name = desired_businesses) |> knitr::kable()
```

For a total of `r fmt(nrow(clean_businesses))` suitable businesses.

#### Business types


### Forward Sortation Areas (FSAs)


# Methodology

# Results

## Scatter plots
```{r}
merged_counts <- left_join(
  dispensary_counts,
  business_counts,
  by = "fsa",
  suffix = c(".dispensaries", ".businesses")
)
```

```{r scatterplots}
merged_counts |>
  group_by(category) |>
  ggplot(aes(x = n.businesses, y = n.dispensaries)) +
  geom_point(alpha = 0.5, size = 0.7, color = "cornflowerblue") +
  geom_line(aes(y = 3), color = "red") +
  facet_wrap(~category, scales = "free") +
  labs("TODO")
```

## Spatial Visualization

```{r spatial-setup}
fsas_by_category <- clean_fsas |>
  left_join(business_counts, by = "fsa") |>
  drop_na(category)
```

```{r chloropleths}
fsas_by_category |>
  ggplot() +
  geom_sf(data = clean_fsas, fill = "black") +
  geom_sf(aes(fill = pmin(n, 50))) +
  geom_point(
    data = clean_dispensaries,
    mapping = aes(x = longitude, y = latitude),
    color = "green",
    size = .25,
    alpha = .5,
  ) +
  scale_fill_viridis_c(option = "magma") +
  facet_wrap(~category) +
  labs("TODO")
```
## Data Summary

```{r summary-table, fig.cap="Data Summary",fig.height=7, fig.width=12, echo=FALSE}

# Make a pivot table with counts of all features
# inside each FSA
fsa_counts_pivot <- fsa_counts |>
  pivot_wider(
    names_from = category, values_from = n.businesses,
    values_fill = 0
  ) |>
  select(-c(geometry, `NA`))
# display the summary as a table in R Markdown
datasummary_skim(
  fsa_counts_pivot,
  type = "numeric",
  output = "default",
  fmt = "%.1f",
  histogram = TRUE,
  title = "Data Summary",
  notes = NULL,
  align = NULL,
  escape = TRUE,
)
```

## Logistical Model

### Logistical Model before AIC
```{r define-model, fig.cap="Logistic model before AIC",fig.height=7, fig.width=12, echo=FALSE}
# Fit a logistic regression model
logistic_model <- glm(
  class ~
    adult_entertainment_club + eating_establishment +
    entertainment_establishment_nightclub + pawn_shop +
    payday_loan + sidewalk_cafe + retail_store_food +
    smoke_shop + vapour_product_retailer + holistic_centre,
  data = fsa_counts_pivot, family = binomial
)

summary(logistic_model)
```

### Logistical Model after AIC
```{r Twenty-three, fig.cap="Logistic model after AIC",fig.height=7, fig.width=12, echo=FALSE}

# Improved logistic model
logistic_model2 <- glm(
  class ~
    adult_entertainment_club + entertainment_establishment_nightclub +
    pawn_shop + sidewalk_cafe + retail_store_food + smoke_shop,
  data = fsa_counts_pivot, family = binomial
)

summary(logistic_model2)
```


### Exponentiate the coefficients
```{r Twenty-four, fig.cap="Exponentiate the coefficients",fig.height=7, fig.width=12, echo=FALSE}

# Improved logistic model
exp(coef(logistic_model2))
```

### K-fold cross-validation
```{r Twenty-five, fig.cap="Exponentiate the coefficients",fig.height=7, fig.width=12, echo=FALSE}

# Set seed for reproducibility
set.seed(123)

# Define cross-validation settings
ctrl <- trainControl(method = "cv", number = 10)

# Train the model using k-fold cross-validation
fit <- train(factor(class) ~ adult_entertainment_club + entertainment_establishment_nightclub + pawn_shop + sidewalk_cafe + retail_store_food + smoke_shop, data = fsa_counts_pivot, method = "glm", family = binomial, trControl = ctrl)

# Get results
print(fit)
```
\newpage

# Discussion

# Conclusion
Our regression model indicates that at least certain types of businesses are significantly ($p < 0.05$) correlated to the likelihood of dispensaries being opened in an arbitrary FSA-sized region of Toronto. [todo more about AIC, methodologies, etc.] Where higher numbers of dispensaries have already been opened, often the most densely populated regions of the city, co-location of multiple dispensaries in close proximity may be indicative of the longer-term stability of retail cannabis in those areas. However, statistical modelling can prove to be an effective tool in determining which geographic regions may be hospitable to a burgeoning cannabis market, inviting early investment and temporarily enjoying the dividends of low competition.

## Considerations
### Data is sparse
Being only a few years removed from legalization, cannabis retail is still in its nascent stages, with even more veteran markets being only a few years its senior. The scene is changing daily, and it is difficult even for licensing bodies like AGCO to track the opening and closing of new locations. This is especially true of black- and grey-market dispensaries, such as First Nations-owned locations which operate on the fringes of treaty law. Although efforts exist to collect and list them, primarily for consumer-facing purposes, there is a distinct lack of verified, up-to-date data on these businesses. It would be of particular interest to investigate these businesses and their market penetration through further study.

### Possible confounding factors
The scope of our study fails to control for a number of important factors, which could bear significant impact on our statistical findings. These include:

#### Population
The high variance in population density across the City of Toronto is a latent variable that affects the density of dispensaries and other businesses alike: where there are more people, there will certainly be more establishments to serve them. It is unknown to what extent our model accounts for this, and it is possible that certain signficant factors for dispensary presence in an FSA could be reliant on data only from downtown regions.

#### Regulations and public infrastructure
Our dataset includes only private business addresses, excluding non-business institutions such as schools, places of worship, and entrances to public and government infrastructure. Future research into the legal constraints of dispensary location – distance from schools, by-law regulations, etc. – may indicate other forces acting on the location of the next dispensary when estimating.

#### Geospatial granularity
The choice to use the 102 FSAs^[As of 2005.] of the City of Toronto as geographic subdivisions was a largely arbitrary one, looking to balance predictive power with visibility and performance when authoring this paper. Other options considered included the electoral ridings or neighbourhood designations of the city; an arbitrary quadrilateral or hexagonal grid, overlain atop a map of Toronto; and even a Voronoi cell system connecting adjacent street intersections into "blocks". Each of these was deemed unsuitable for varied reasons, but future reproductive studies may wish to test whether our results are repeatable on coarser- or finer-grained geographic scales.