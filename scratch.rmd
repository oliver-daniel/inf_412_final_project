```{r setup, echo=FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
    echo = FALSE,
    message = FALSE,
    warning = FALSE,
    cache = TRUE
)
# options(device  = "X11")
# X11(type = "cairo")
```

```{r libraries}
library(tidyverse)
library(sf)
```

```{r fetch-data}
source("scripts/fetch-data.r")
```

```{r}
businesses <- data.businesses |>
    filter(`Licence Address Line 3` |> str_starts("M")) |>
    filter(Category |> str_detect(paste(
        c(
            "RETAIL STORE \\(FOOD\\)",
            "SMOKE SHOP",
            "VAPOUR PRODUCT RETAILER"
        ),
        collapse = "|"
    )))

dispensaries <- data.dispensaries |>
    filter(str_starts(PostalCode, "M")) |>
    filter(ApplicationStatus == "Authorized to Open")
```

```{r}
# Cloropleth of open dispensaries by neighbourhood

dispensaries.sf <- st_as_sf(
    dispensaries,
    coords = c("Longitude", "Latitude"), crs = 4326
)

dispensaries_per_neighbourhood <- data.neighbourhoods |>
    st_contains(dispensaries.sf) |>
    lengths()

data.neighbourhoods |>
    bind_cols("dispensary_count" = dispensaries_per_neighbourhood) |>
    ggplot(aes(fill = dispensary_count)) +
    geom_sf() +
    geom_point(
        data = dispensaries,
        mapping = aes(x = Longitude, y = Latitude),
        color = "cyan",
        size = .5,
        alpha = .5,
        inherit.aes = F
    ) +
    scale_fill_viridis_c("Dispensaries", option = "magma")
```

```{r}
neighbourhoods.sf <- data.neighbourhoods |>
    # drop_na(Latitude, Longitude) |>
    st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)



data.neighbourhoods |>
    ggplot() +
    geom_sf() +
    geom_sf(data = data.intersections, alpha=.1)
```

```{r}
data.intersections |>
    head(5) |>
    st_distance(dispensaries.sf |> head(5))
```